/**
 * Copyright (C) 2010 Graham Breach
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
/**
 * jQuery.tagcanvas 1.4
 * For more information, please contact <graham@goat1000.com>
 */
(function(b){var a={Point3D:function(c,e,d){this.x=c;this.y=e;this.z=d},RotX:function(f,d){var e=Math.sin(d),g=Math.cos(d);return new a.Point3D(f.x,(f.y*g)+(f.z*e),(f.y*-e)+(f.z*g))},RotY:function(f,d){var e=Math.sin(d),g=Math.cos(d);return new a.Point3D((f.x*g)+(f.z*-e),f.y,(f.x*e)+(f.z*g))},RotZ:function(f,d){var e=Math.sin(d),g=Math.cos(d);return new a.Point3D((f.x*g)+(f.y*e),(f.x*-e)+(f.y*g),f.z)},Project:function(j,d,g,e,f){var k,i,c;k=(j.y*a.z1)/(a.z1+a.z2+j.z);i=(j.x*a.z1)/(a.z1+a.z2+j.z);c=a.z2+j.z;return new a.Point3D(i,k,c)},Draw:function(e){var j=0,f,h,k,d,g;k=e.getContext("2d");k.clearRect(0,0,e.width,e.height);k.strokeStyle="white";k.fillStyle="white";f=e.width/2;h=e.height/2;this.active=null;for(g=0;g<this.taglist.length;++g){this.taglist[g].Calc(this.yaw,this.pitch)}this.taglist=this.taglist.sort(function(i,c){return i.sc-c.sc});for(g=0;g<this.taglist.length;++g){d=this.taglist[g].Draw(k,f,h);if(d&&d.sc>j){this.active=d;this.active.index=g;j=d.sc}}if(a.freezeActive&&this.active){this.yaw=this.pitch=0}else{this.Animate(e.width,e.height)}if(this.active){this.active.Draw(k)}},Animate:function(c,e){if(a.mx>=0&&a.my>=0&&a.mx<c&&a.my<e){this.yaw=(a.maxSpeed*2*a.mx/c)-a.maxSpeed;this.pitch=-((a.maxSpeed*2*a.my/e)-a.maxSpeed);if(a.reverse){this.yaw=-this.yaw;this.pitch=-this.pitch}a.initial=null}else{if(!a.initial){var f=Math.abs(this.yaw),d=Math.abs(this.pitch);if(f>a.minSpeed){this.yaw=f>a.z0?this.yaw*a.decel:0}if(d>a.minSpeed){this.pitch=d>a.z0?this.pitch*a.decel:0}}}},Clicked:function(d){try{if(this.active&&this.taglist[this.active.index]){this.taglist[this.active.index].Clicked(d)}}catch(c){}},Outline:function(){this.ts=new Date();this.Update=function(c,g,d,e,f){this.x=f*(c-a.outlineOffset);this.y=f*(g-a.outlineOffset);this.w=f*(d+a.outlineOffset*2);this.h=f*(e+a.outlineOffset*2);this.sc=f};this.Draw=function(e){var d=new Date()-this.ts;e.save();e.strokeStyle=a.outlineColour;e.lineWidth=a.outlineThickness;if(a.pulsateTo<1){e.globalAlpha=a.pulsateTo+((1-a.pulsateTo)*(0.5+(Math.cos(2*Math.PI*d/(1000*a.pulsateTime))/2)))}e.beginPath();e.rect(this.x,this.y,this.w,this.h);e.closePath();e.stroke();e.restore()};this.Active=function(f,d,e){return(d>=this.x&&e>=this.y&&d<=this.x+this.w&&e<=this.y+this.h)};this.Update(0,0,0,0,1)},Tag:function(f,d,e,c,g){this.image=f.src?f:null;this.name=f.src?"":f;this.a=d;this.p3d=new a.Point3D;this.p3d.x=e[0]*a.radius*1.1;this.p3d.y=e[1]*a.radius*1.1;this.p3d.z=e[2]*a.radius*1.1;this.x=0;this.y=0;this.w=c;this.h=g;this.sc=1;this.alpha=1;this.outline=new a.Outline();this.Draw=function(k,i,j){var h;k.save();k.globalAlpha=this.alpha;k.scale(this.sc,this.sc);i=i/this.sc;j=j/this.sc;k.textBaseline="top";k.fillStyle=a.textColour;k.font=a.textHeight+"px "+a.textFont;if(this.image){this.w1=this.w*this.sc;this.h1=this.h*this.sc}else{h=k.measureText(this.name);this.w1=h.width+2;this.h1=this.h}i=i-(this.w1/2);j=j-(this.h1/2);if(this.image){k.drawImage(this.image,i+this.x,j+this.y,this.image.width*this.sc,this.image.height*this.sc)}else{k.fillText(this.name,i+this.x+1,j+this.y+1,this.w1-2)}k.restore();this.outline.Update(i+this.x,j+this.y,this.w1,this.h1,this.sc);if(this.outline.Active(k,a.mx,a.my)){return this.outline}return null};this.Calc=function(j,i){var h=a.RotY(this.p3d,j);this.p3d=a.RotX(h,i);h=a.Project(this.p3d,this.w,this.h,Math.PI/4,20);this.x=h.x;this.y=h.y;this.sc=(a.z1+a.z2-h.z)/a.z2;this.alpha=a.minBrightness+1-((h.z-a.z2+a.radius)/(2*a.radius))};this.Clicked=function(i){if(this.a.fireEvent){if(!this.a.fireEvent("onclick")){return}}else{var h=document.createEvent("MouseEvents");h.initMouseEvent("click",true,true,window,0,0,0,0,0,false,false,false,false,0,null);if(!this.a.dispatchEvent(h)){return}}if(this.a.target==""||this.a.target=="_self"){document.location=this.a.href}else{if(self.frames[this.a.target]){self.frames[this.a.target]=this.a.href}else{if(top.frames[this.a.target]){top.frames[this.a.target]=this.a.href}else{window.open(this.a.href,this.a.target)}}}}},MouseMove:function(c){if(c.pageX){a.mx=c.pageX-a.cx;a.my=c.pageY-a.cy}else{a.mx=c.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft)-a.cx;a.my=c.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop)-a.cy}},MouseClick:function(c){a.MouseMove(c);a.Clicked(c)},PointsOnSphere:function(k){var c,j,e,d,h=[],f=Math.PI*(3-Math.sqrt(5)),g=2/k;for(c=0;c<k;++c){j=c*g-1+(g/2);e=Math.sqrt(1-j*j);d=c*f;h.push([Math.cos(d)*e,j,Math.sin(d)*e])}return h},AddImage:function(e,d,c){jQuery(e).bind("load",function(){d.w=this.width;d.h=this.height;c.push(d)})},mx:-1,my:-1,cx:0,cy:0,z1:20000,z2:20000,z0:0.0002,freezeActive:false,pulsateTo:1,pulsateTime:3,reverse:false,depth:0.5,maxSpeed:0.05,minSpeed:0,decel:0.95,initial:null,minBrightness:0.1,outlineColour:"#ffff99",outlineThickness:2,outlineOffset:5,textColour:"#ff99ff",textHeight:15,textFont:"Helvetica, Arial, sans-serif"};jQuery.fn.tagcanvas=function(f,d){var c,j=this.offset(),e=this.eq(0),g,h=d?jQuery("#"+d):this;if(document.all&&!d){return false}c=h.find("a");if(typeof(G_vmlCanvasManager)!="undefined"){e[0]=G_vmlCanvasManager.initElement(e[0])}if(!c.length||!e[0].getContext||!e[0].getContext("2d").fillText){return false}for(g in f){a[g]=f[g]}a.z1=(19800/(Math.exp(a.depth)*(1-1/Math.E)))+20000-19800/(1-(1/Math.E));a.z2=a.z1;e.each(function(){var m,o,l,n,k;a.radius=(this.height>this.width?this.width:this.height)*0.33*(a.z2+a.z1)/(a.z1);a.taglist=[];o=a.PointsOnSphere(c.length);for(m=0;m<c.length;++m){l=c[m].getElementsByTagName("img");if(l.length){n=new Image;n.src=l[0].src;k=new a.Tag(n,c[m],o[m],1,1);a.AddImage(n,k,a.taglist)}else{a.taglist.push(new a.Tag(c[m].innerText?c[m].innerText:c[m].textContent,c[m],o[m],2,a.textHeight+2))}}a.yaw=a.initial?a.initial[0]*a.maxSpeed:0;a.pitch=a.initial?a.initial[1]*a.maxSpeed:0;a.cx=j.left;a.cy=j.top;if(!a.started){jQuery(document).bind("mousemove",a.MouseMove);jQuery(document).bind("mouseout",a.MouseMove);jQuery(document).bind("mousedown",a.MouseClick);a.started=setInterval(function(){a.Draw(e[0])},10)}});if(d&&a.hideTags){h.hide()}return true}})(jQuery);